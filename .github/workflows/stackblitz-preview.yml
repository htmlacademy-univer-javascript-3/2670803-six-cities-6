name: StackBlitz Preview

on:
  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  pull-requests: write

jobs:
  add-link:
    runs-on: ubuntu-latest
    steps:
      - name: Comment with StackBlitz Link
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            try {
              // –ò—Å–ø–æ–ª—å–∑—É–µ–º head —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π (—Ñ–æ—Ä–∫) –∏ –≤–µ—Ç–∫—É PR
              const pr = context.payload.pull_request;
              const headRepo = pr.head.repo;
              const branch = pr.head.ref;
              const owner = headRepo.owner.login;
              const repo = headRepo.name;

              const stackblitzUrl = `https://stackblitz.com/github/${owner}/${repo}/tree/${branch}?startScript=start`;

              await github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: `üöÄ **Preview on StackBlitz:**\n\n[Open in StackBlitz](${stackblitzUrl})`
              });
            } catch (error) {
              const pr = context.payload.pull_request;
              const headRepo = pr.head.repo;
              const branch = pr.head.ref;
              const owner = headRepo.owner.login;
              const repo = headRepo.name;
              const stackblitzUrl = `https://stackblitz.com/github/${owner}/${repo}/tree/${branch}?startScript=start`;

              console.warn(`–ù–µ —É–¥–∞–ª–æ—Å—å –¥–æ–±–∞–≤–∏—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –≤ PR: ${error.message}`);
              console.log(`\nüîó StackBlitz: ${stackblitzUrl}`);

              const fs = require('fs');
              const summaryPath = process.env.GITHUB_STEP_SUMMARY;
              if (summaryPath) {
                const summary = `## üîó StackBlitz Preview\n\n**–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω.** –°–∫–æ–ø–∏—Ä—É–π—Ç–µ —Å—Å—ã–ª–∫—É –∏ –¥–æ–±–∞–≤—å—Ç–µ –≤ PR –≤—Ä—É—á–Ω—É—é:\n\n[${stackblitzUrl}](${stackblitzUrl})`;
                fs.appendFileSync(summaryPath, summary);
              }
            }
